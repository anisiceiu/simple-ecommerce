@using System.Security.Claims
@model ECommerce.Domain.Entities.ChatRoom

@{
    ViewBag.Title = "Chat Room";
    Layout = "_LayoutAdmin";
}

<h2>Chat with @Model.UserId</h2>

<div id="chatWindow" style="height:400px; overflow-y:auto; border:1px solid #ccc; padding:10px;">
    @foreach (var msg in Model.Messages.OrderBy(m => m.SentAt))
    {
        <div>
            <strong>@(msg.SenderId == User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier) ? "Me" : "User"):</strong>
            @msg.MessageText
        </div>
    }
</div>

<div class="input-group mt-2">
    <input id="messageInput" class="form-control" placeholder="Type a message..." />
    <div class="input-group-append">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
</div>

<input type="hidden" id="roomId" value="@Model.Id" />


    <script>
           
            const connectionAdmineach = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();
            
        const roomId = document.getElementById("roomId").value;
        const chatWindow = document.getElementById("chatWindow");

    connectionAdmineach.start().then(() => connectionAdmineach.invoke("JoinRoom", roomId));

        connectionAdmineach.on("ReceiveMessage", (senderId, message, time) => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${senderId === "@User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier)" ? "Me" : "User"}:</strong> ${message}`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        });

        function sendMessage() {
            const msg = document.getElementById("messageInput").value;
            if (!msg) return;
            connectionAdmineach.invoke("SendMessage", roomId, msg);
            document.getElementById("messageInput").value = "";
        }
    </script>

