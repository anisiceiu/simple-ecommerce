@using System.Security.Claims
@using ECommerce.Domain.Entities
@model ChatRoom

<div class="card">
    <div class="card-header bg-primary text-white">
        Support Chat
    </div>

    <div class="card-body" id="chatWindow" style="height:300px; overflow-y:auto;">
        @foreach (var msg in Model.Messages.OrderBy(x => x.SentAt))
        {
            <div>
                <strong>@(msg.SenderId == User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier) ? "Me" : "Support"):</strong>
                @msg.MessageText
            </div>
        }
    </div>

    <div class="card-footer">
        <div class="input-group">
            <input id="messageInput" class="form-control" placeholder="Type a message..." />
            <div class="input-group-append">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="roomId" value="@Model.Id" />


    
    <script>
        const connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
        const roomId = document.getElementById("roomId").value;
        const chatWindow = document.getElementById("chatWindow");

        connection.start().then(() => connection.invoke("JoinRoom", roomId));

        connection.on("ReceiveMessage", (senderId, message, time) => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${senderId === "@User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier)" ? "Me" : "Support"}:</strong> ${message}`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        });

        function sendMessage() {
            const msg = document.getElementById("messageInput").value;
            if(!msg) return;
            connection.invoke("SendMessage", roomId, msg);
            document.getElementById("messageInput").value = "";
        }
    </script>

